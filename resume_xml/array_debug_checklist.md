## Array Extraction Troubleshooting Checklist

| Attempt # | Change made | Result / observation | Next action |
|-----------|-------------|----------------------|-------------|
| 1 | Added aggregation query with `ARRAY_AGG(... FILTER (...))` (see `employment_arrays_query.md` v1). | Snowflake syntax error because `FILTER` clause not enabled in account. | Swap to `CASE` inside aggregates. |
| 2 | Replaced `FILTER` with `ARRAY_AGG(DISTINCT CASE WHEN ... END)` to drop nulls. | Query compiled. Arrays still empty because node text still wrapped as XML VARIANT. | Convert XML nodes to strings. |
| 3 | Replaced unsupported `XMLTEXT` helper with `XMLGET(...):"$"::STRING` per Snowflake XML docs (`XMLGET` reference). | Text extraction fixed. Still null data since `FLATTEN` inputs pointed at XML hierarchy incorrectly. | Revisit `FLATTEN` pathing. |
| 4 | Switched `FLATTEN` inputs to use JSON-style `:EmployerOrg` / `:PositionHistory` accessors. | Query ran but arrays remained null because XML VARIANTs donâ€™t expose child nodes through JSON accessors. | Use `XMLGET` at every nested level instead of JSON accessors. |
| 5 | `FLATTEN` now wraps `XMLGET(..., 'EmployerOrg')`, `XMLGET(org.value, 'PositionHistory')`, and education equivalents, all with `OUTER => TRUE`. | Still empty arrays, indicating `FLATTEN` is iterating the child keys (EmployerOrgName, PositionHistory, etc.) rather than the entire node payload. | Dump `org.value` / `position.value` to confirm and consider abandoning `FLATTEN` for this data shape. |
| 6 | Added `employment_arrays_no_flatten.md`, replacing `FLATTEN` with `TABLE(GENERATOR())` loops that feed the 0-based `instance_number` argument of `XMLGET` (per Snowflake docs lines `882-973`). | Pending validation; this should "drill down" each ordinal explicitly and avoid the key/value rows that were blanking the arrays. | If it still fails, log intermediate `org_node` / `position_node` variants to inspect the parsed structure. |
| 7 | **Root cause found:** Previous queries used `XMLGET(res.structured_resume, 'EmploymentHistory'):"EmployerOrg"` which doesn't work because Snowflake XML VARIANTs store child elements in a `"$"` array, not as direct JSON keys. Fixed by: (1) flattening `employment_history:"$"` to get all child nodes, (2) filtering with `GET(value, '@') = 'EmployerOrg'` to select only EmployerOrg elements, (3) repeating for PositionHistory. This matches the Snowflake KB article "HOW TO QUERY NESTED XML DATA IN SNOWFLAKE". | Expected to work now. | Run query and verify arrays populate. |
| 8 | **Second root cause found:** Using `WHERE GET(n.value, '@') = 'sov:Name'` after `FLATTEN(..., OUTER => TRUE)` was filtering out rows, defeating the purpose of `OUTER => TRUE`. The `LEFT JOIN` then had no matching rows. **Fix:** Moved the tag filter into a `CASE WHEN` expression inside the `SELECT`, so rows are preserved but non-matching tags produce NULL values. `ARRAY_COMPACT` then removes these NULLs from the final arrays. Applied to all CTEs: `reserved_names`, `reserved_phones`, `reserved_emails`, `employment`, and `education`. | Still returned empty arrays. | Investigate deeper. |
| 9 | **Third root cause found:** The `FLATTEN` on `"$"` approach is fundamentally unreliable for Snowflake XML. The `"$"` array behavior is inconsistent: (a) for single-child elements, Snowflake may store the child directly instead of in an array, (b) namespace prefixes may be stored differently than expected in the `@` attribute. **Complete rewrite:** Abandoned `FLATTEN` approach entirely. Now using `XMLGET(parent, 'tagname', instance_number)` with `TABLE(GENERATOR(ROWCOUNT => N))` to create index sequences (0, 1, 2, ...). This explicitly fetches each occurrence by index, which works reliably regardless of internal representation. Also changed from `sov:NormalizedTitle`/`sov:NormalizedDegreeName` to direct `Title`/`DegreeName` fields as requested. | Should now work. | Run query and verify. |

> **Note:** The `failed_xml1.xml` and `failed_xml2.xml` files do NOT contain `sov:NormalizedOrganizationName` or `sov:NormalizedTitle` tags. This is expected - those fields were removed from the query in favor of direct `Title` and `DegreeName` fields.

> Keep this table updated each time a new fix is attempted so we avoid repeating the same approach.

