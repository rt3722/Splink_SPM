name: Coverage
on:
  push: { branches: [ main ] }
  pull_request: { branches: [ main ] }

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-python@v5
        with: { python-version: "3.10", cache: pip }

      - name: Install uv
        run: python -m pip install uv

      - name: System deps (mlpack)
        run: |
          sudo apt-get update
          sudo apt-get install -y libmlpack-dev

      - name: Install deps
        run: |
          uv venv

          uv pip install faiss-cpu
          uv pip install -e packages/blockingpy-core[dev]
          uv pip install pytest-cov coverage

      - name: Test CPU
        env:
          COVERAGE_FILE: .coverage.cpu
        run: |
          uv run pytest --ignore=tests/test_gpu_faiss.py \
                --cov=blockingpy --cov-branch --cov-report=term-missing

      - name: Test GPU (mocked)
        env:
          BPY_GPU_ONLY: "1"
          BPY_GPU_MOCK: "1"
          PYTEST_DISABLE_PLUGIN_AUTOLOAD: "1"
          COVERAGE_FILE: .coverage.gpu_mock
        run: |
          uv run pytest tests/test_gpu_faiss.py \
            -p pytest_cov \
            --cov=blockingpy.gpu_faiss_blocker \
            --cov-branch --cov-report=term-missing

      - name: Combine + XML
        run: |
          uv run coverage combine .coverage.cpu .coverage.gpu_mock
          uv run coverage xml -o coverage.xml
          uv run coverage report -m

      - name: Upload to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}  
          files: coverage.xml
          flags: cpu,gpu-mock
          fail_ci_if_error: true
